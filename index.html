<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Photo Metadata Editor Pro</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/piexifjs@1.0.6/piexif.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 100%);
      color: #e0e0e0;
      min-height: 100vh;
      padding-bottom: 2rem;
    }
    header {
      background: rgba(30, 30, 50, 0.9);
      backdrop-filter: blur(10px);
      padding: 1.5rem 2rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    h1 {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 1rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }
    button, .file-input-wrapper {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 0.65rem 1.25rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    button:hover:not(:disabled), .file-input-wrapper:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .file-input-wrapper {
      display: inline-block;
      position: relative;
    }
    .file-input-wrapper input[type="file"] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    #scramble {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    #save {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    #strip-all {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    #compare {
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      color: #333;
    }
    main {
      max-width: 1800px;
      margin: 2rem auto;
      padding: 0 2rem;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }
    @media (max-width: 1200px) {
      main {
        grid-template-columns: 1fr;
      }
    }
    .panel {
      background: rgba(30, 30, 50, 0.6);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    .panel h2 {
      font-size: 1.3rem;
      margin-bottom: 1rem;
      color: #a8b2d1;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    #preview {
      width: 100%;
      height: auto;
      max-height: 500px;
      object-fit: contain;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.3);
      display: block;
    }
    .image-info {
      margin-top: 1rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.75rem;
    }
    .info-item {
      background: rgba(0, 0, 0, 0.3);
      padding: 0.75rem;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .info-label {
      font-size: 0.75rem;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .info-value {
      font-size: 1rem;
      font-weight: 600;
      color: #a8b2d1;
      margin-top: 0.25rem;
    }
    .placeholder {
      width: 100%;
      height: 300px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      color: #666;
      font-size: 1.1rem;
      border: 2px dashed rgba(102, 126, 234, 0.3);
      transition: all 0.3s ease;
    }
    .placeholder.drag-over {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.1);
    }
    .placeholder-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }
    .search-box {
      margin-bottom: 1rem;
      position: relative;
    }
    .search-box input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 2.5rem;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(0, 0, 0, 0.3);
      color: #e0e0e0;
      font-size: 0.9rem;
    }
    .search-box::before {
      content: "üîç";
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1rem;
    }
    #metadata-form {
      max-height: 450px;
      overflow-y: auto;
      padding-right: 0.5rem;
    }
    #metadata-form::-webkit-scrollbar, #json-view::-webkit-scrollbar {
      width: 8px;
    }
    #metadata-form::-webkit-scrollbar-track, #json-view::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }
    #metadata-form::-webkit-scrollbar-thumb, #json-view::-webkit-scrollbar-thumb {
      background: rgba(102, 126, 234, 0.5);
      border-radius: 4px;
    }
    .section-title {
      font-size: 0.9rem;
      font-weight: 700;
      color: #667eea;
      margin: 1rem 0 0.5rem;
      padding-bottom: 0.25rem;
      border-bottom: 1px solid rgba(102, 126, 234, 0.3);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .section-title:first-child {
      margin-top: 0;
    }
    .mini-btn {
      background: rgba(102, 126, 234, 0.2);
      border: 1px solid rgba(102, 126, 234, 0.3);
      color: #667eea;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .mini-btn:hover {
      background: rgba(102, 126, 234, 0.3);
    }
    .entry {
      margin-bottom: 1rem;
    }
    .entry label {
      display: block;
      font-size: 0.85rem;
      color: #a8b2d1;
      margin-bottom: 0.35rem;
      font-weight: 500;
    }
    .entry input {
      width: 100%;
      padding: 0.6rem;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(0, 0, 0, 0.3);
      color: #e0e0e0;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }
    .entry input:focus {
      outline: none;
      border-color: #667eea;
      background: rgba(0, 0, 0, 0.4);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    #json-view {
      background: rgba(0, 0, 0, 0.4);
      padding: 1rem;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      color: #a8e6cf;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .json-actions {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .map-panel {
      grid-column: 1 / -1;
    }
    #map {
      height: 400px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .map-controls {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }
    .map-controls input {
      flex: 1;
      min-width: 200px;
      padding: 0.5rem;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(0, 0, 0, 0.3);
      color: #e0e0e0;
    }
    .empty-state {
      text-align: center;
      padding: 2rem;
      color: #666;
    }
    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    .info-badge {
      display: inline-block;
      background: rgba(102, 126, 234, 0.2);
      color: #667eea;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }
    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: rgba(30, 30, 50, 0.95);
      backdrop-filter: blur(10px);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      border: 1px solid rgba(102, 126, 234, 0.5);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      transform: translateY(150%);
      transition: transform 0.3s ease;
      z-index: 1000;
      max-width: 300px;
    }
    .toast.show {
      transform: translateY(0);
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.show {
      display: flex;
    }
    .modal-content {
      background: rgba(30, 30, 50, 0.95);
      border-radius: 16px;
      padding: 2rem;
      max-width: 90%;
      max-height: 90%;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    .modal-close {
      background: none;
      border: none;
      color: #999;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
    }
    .modal-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }
    .compare-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }
    @media (max-width: 768px) {
      .compare-grid {
        grid-template-columns: 1fr;
      }
    }
    .compare-item h4 {
      color: #667eea;
      margin-bottom: 0.5rem;
    }
    .compare-item pre {
      background: rgba(0, 0, 0, 0.3);
      padding: 1rem;
      border-radius: 8px;
      font-size: 0.8rem;
      max-height: 400px;
      overflow-y: auto;
    }
    .batch-controls {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }
    .batch-counter {
      color: #a8b2d1;
      padding: 0.65rem 1.25rem;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <header>
    <h1>üì∑ Photo Metadata Editor Pro</h1>
    <div class="toolbar">
      <div class="file-input-wrapper">
        üìÅ Load Image
        <input type="file" id="main-upload" accept="image/jpeg,image/jpg">
      </div>
      <div class="file-input-wrapper">
        üìÇ Batch Load
        <input type="file" id="batch-upload" accept="image/jpeg,image/jpg" multiple>
      </div>
      <div class="file-input-wrapper">
        üîÑ Copy Metadata
        <input type="file" id="meta-upload" accept="image/jpeg,image/jpg">
      </div>
      <button id="strip-all" disabled>üóëÔ∏è Strip All</button>
      <button id="scramble" disabled>üé≤ Randomize</button>
      <button id="compare" disabled>‚öñÔ∏è Compare</button>
      <button id="save" disabled>üíæ Save</button>
    </div>
  </header>

  <main>
    <section class="panel">
      <h2>üñºÔ∏è Image Preview</h2>
      <div id="preview-container">
        <div class="placeholder">
          <div class="placeholder-icon">üì∏</div>
          <p>Drop an image or click "Load Image"</p>
        </div>
      </div>
      <div class="image-info" id="image-info" style="display: none;">
        <div class="info-item">
          <div class="info-label">Dimensions</div>
          <div class="info-value" id="dimensions">-</div>
        </div>
        <div class="info-item">
          <div class="info-label">File Size</div>
          <div class="info-value" id="filesize">-</div>
        </div>
        <div class="info-item">
          <div class="info-label">Format</div>
          <div class="info-value">JPEG</div>
        </div>
        <div class="info-item">
          <div class="info-label">Camera</div>
          <div class="info-value" id="camera">-</div>
        </div>
      </div>
      <div class="batch-controls" id="batch-controls" style="display: none;">
        <button id="prev-batch" class="mini-btn">‚¨ÖÔ∏è Previous</button>
        <span class="batch-counter" id="batch-counter">1 / 1</span>
        <button id="next-batch" class="mini-btn">‚û°Ô∏è Next</button>
        <button id="save-all-batch" class="mini-btn">üíæ Save All</button>
      </div>
    </section>

    <section class="panel">
      <h2>üß¨ Metadata Editor</h2>
      <div class="search-box">
        <input type="text" id="search-meta" placeholder="Search metadata fields...">
      </div>
      <div id="metadata-form">
        <div class="empty-state">
          <div class="empty-state-icon">üìã</div>
          <p>No metadata loaded yet</p>
        </div>
      </div>
      <h2 style="margin-top: 1.5rem;">üìÑ Raw JSON</h2>
      <div class="json-actions">
        <button class="mini-btn" id="copy-json">üìã Copy</button>
        <button class="mini-btn" id="download-json">‚¨áÔ∏è Download</button>
      </div>
      <pre id="json-view">{}</pre>
    </section>

    <section class="panel map-panel">
      <h2>üó∫Ô∏è GPS Location <span class="info-badge" id="gps-status">No GPS data</span></h2>
      <div id="map"></div>
      <div class="map-controls">
        <button class="mini-btn" id="center-map" disabled>üéØ Center</button>
        <button class="mini-btn" id="clear-gps" disabled>üóëÔ∏è Remove GPS</button>
        <button class="mini-btn" id="add-gps" disabled>‚ûï Add GPS</button>
        <input type="text" id="search-location" placeholder="Search location (e.g., Paris, France)">
        <button class="mini-btn" id="search-location-btn">üîç Search</button>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <div id="compare-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚öñÔ∏è Metadata Comparison</h2>
        <button class="modal-close">√ó</button>
      </div>
      <div class="compare-grid" id="compare-content"></div>
    </div>
  </div>

  <script>
    const previewContainer = document.getElementById("preview-container");
    const mainUpload = document.getElementById("main-upload");
    const batchUpload = document.getElementById("batch-upload");
    const metaUpload = document.getElementById("meta-upload");
    const form = document.getElementById("metadata-form");
    const jsonView = document.getElementById("json-view");
    const scrambleBtn = document.getElementById("scramble");
    const saveBtn = document.getElementById("save");
    const stripAllBtn = document.getElementById("strip-all");
    const compareBtn = document.getElementById("compare");
    const gpsStatus = document.getElementById("gps-status");
    const searchMeta = document.getElementById("search-meta");
    const toast = document.getElementById("toast");
    const compareModal = document.getElementById("compare-modal");

    let originalDataURL = null;
    let originalExifData = null;
    let exifData = null;
    let currentFile = null;
    let mapInstance = null;
    let mapMarker = null;
    let batchFiles = [];
    let currentBatchIndex = 0;

    function formatBytes(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    function showToast(message, duration = 3000) {
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), duration);
    }

    previewContainer.addEventListener('dragover', (e) => {
      e.preventDefault();
      const placeholder = previewContainer.querySelector('.placeholder');
      if (placeholder) placeholder.classList.add('drag-over');
    });

    previewContainer.addEventListener('dragleave', () => {
      const placeholder = previewContainer.querySelector('.placeholder');
      if (placeholder) placeholder.classList.remove('drag-over');
    });

    previewContainer.addEventListener('drop', (e) => {
      e.preventDefault();
      const placeholder = previewContainer.querySelector('.placeholder');
      if (placeholder) placeholder.classList.remove('drag-over');
      if (e.dataTransfer.files.length) {
        loadImage(e.dataTransfer.files[0]);
      }
    });

    function loadImage(file, replaceMetaOnly = false) {
      currentFile = file;
      const reader = new FileReader();
      reader.onload = function (e) {
        const base64 = e.target.result;

        if (!replaceMetaOnly) {
          originalDataURL = base64;
          const img = new Image();
          img.onload = function() {
            document.getElementById('dimensions').textContent = `${img.width} √ó ${img.height}`;
          };
          img.id = 'preview';
          img.src = base64;
          previewContainer.innerHTML = '';
          previewContainer.appendChild(img);
          
          document.getElementById('filesize').textContent = formatBytes(file.size);
          document.getElementById('image-info').style.display = 'grid';
        }

        try {
          const exif = piexif.load(base64);
          exifData = exif;
          originalExifData = JSON.parse(JSON.stringify(exif));
          
          if (!exifData["GPS"]) {
            exifData["GPS"] = {};
          }

          const make = exifData["0th"]?.[piexif.ImageIFD.Make] || '';
          const model = exifData["0th"]?.[piexif.ImageIFD.Model] || '';
          document.getElementById('camera').textContent = make && model ? `${make} ${model}` : 'Unknown';
          
          scrambleBtn.disabled = false;
          saveBtn.disabled = false;
          stripAllBtn.disabled = false;
          compareBtn.disabled = false;
          document.getElementById('add-gps').disabled = false;

          showToast(replaceMetaOnly ? '‚úÖ Metadata replaced' : '‚úÖ Image loaded');
        } catch (err) {
          exifData = {
            "0th": {},
            "Exif": {},
            "GPS": {},
            "Interop": {},
            "1st": {},
            "thumbnail": null
          };
          originalExifData = JSON.parse(JSON.stringify(exifData));
          document.getElementById('camera').textContent = 'None';
          scrambleBtn.disabled = false;
          saveBtn.disabled = false;
          stripAllBtn.disabled = false;
          compareBtn.disabled = false;
          document.getElementById('add-gps').disabled = false;
          
          showToast('‚ö†Ô∏è No EXIF data found');
        }

        renderForm();
        updateMapFromExif(exifData);
        jsonView.textContent = JSON.stringify(exifData, null, 2);
      };
      reader.readAsDataURL(file);
    }

    function renderForm() {
      const searchTerm = searchMeta.value.toLowerCase();
      form.innerHTML = "";
      
      const sections = ["0th", "Exif", "GPS", "Interop"];
      
      sections.forEach(section => {
        if (!exifData[section] || typeof exifData[section] !== 'object') return;
        
        const entries = Object.entries(exifData[section]).filter(([tag, val]) => 
          val !== null && val !== undefined && tag !== 'thumbnail'
        );
        
        if (entries.length === 0) return;

        const sectionTitle = document.createElement("div");
        sectionTitle.className = "section-title";
        sectionTitle.textContent = section;
        
        let sectionHasVisibleEntries = false;
        const sectionContainer = document.createElement("div");

        entries.forEach(([tag, val]) => {
          const tagInfo = piexif.TAGS[section]?.[tag];
          const name = tagInfo?.name || `Tag ${tag}`;

          if (searchTerm && !name.toLowerCase().includes(searchTerm) && !String(val).toLowerCase().includes(searchTerm)) {
            return;
          }

          sectionHasVisibleEntries = true;

          const wrapper = document.createElement("div");
          wrapper.className = "entry";

          const label = document.createElement("label");
          label.textContent = name;

          const input = document.createElement("input");
          input.dataset.section = section;
          input.dataset.tag = tag;
          
          if (Array.isArray(val)) {
            input.value = val.join(", ");
          } else if (typeof val === 'object') {
            input.value = JSON.stringify(val);
          } else {
            input.value = val;
          }

          input.addEventListener('input', () => {
            updateExifFromForm();
            jsonView.textContent = JSON.stringify(exifData, null, 2);
          });

          wrapper.appendChild(label);
          wrapper.appendChild(input);
          sectionContainer.appendChild(wrapper);
        });

        if (sectionHasVisibleEntries) {
          form.appendChild(sectionTitle);
          form.appendChild(sectionContainer);
        }
      });
      
      if (form.innerHTML === "") {
        form.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><p>No metadata found</p></div>';
      }
    }

    function updateExifFromForm() {
      const inputs = form.querySelectorAll("input");
      inputs.forEach(input => {
        const section = input.dataset.section;
        const tag = input.dataset.tag;
        const raw = input.value.trim();

        if (!raw) return;

        let val;
        if (raw.includes(",")) {
          const parts = raw.split(",").map(v => v.trim());
          val = parts.map(v => {
            const num = parseFloat(v);
            return isNaN(num) ? v : num;
          });
        } else if (!isNaN(raw) && raw !== '') {
          val = parseFloat(raw);
        } else {
          val = raw;
        }

        if (!exifData[section]) {
          exifData[section] = {};
        }
        exifData[section][tag] = val;
      });
    }

    function scrambleMetadata() {
      if (!exifData) return;
      
      const now = new Date();
      const formattedDate = now.toISOString().replace(/[T\-:\.Z]/g, ' ').trim().substring(0, 19);

      const randomCoords = () => {
        const deg = Math.floor(Math.random() * 90);
        const min = Math.floor(Math.random() * 60);
        const sec = Math.floor(Math.random() * 60);
        return [deg, min, sec];
      };

      const randomStr = () => Math.random().toString(36).substring(2, 10).toUpperCase();

      if (!exifData["0th"]) exifData["0th"] = {};
      exifData["0th"][piexif.ImageIFD.Make] = `Brand${randomStr()}`;
      exifData["0th"][piexif.ImageIFD.Model] = `Model${randomStr()}`;
      exifData["0th"][piexif.ImageIFD.Software] = "PhotoEditor Pro 2024";

      if (!exifData["Exif"]) exifData["Exif"] = {};
      exifData["Exif"][piexif.ExifIFD.DateTimeOriginal] = formattedDate;
      exifData["Exif"][piexif.ExifIFD.LensMake] = `Lens${randomStr()}`;
      exifData["Exif"][piexif.ExifIFD.LensModel] = `${Math.floor(Math.random() * 100) + 10}mm f/${(Math.random() * 4 + 1).toFixed(1)}`;

      if (!exifData["GPS"]) exifData["GPS"] = {};
      exifData["GPS"][piexif.GPSIFD.GPSLatitudeRef] = Math.random() > 0.5 ? "N" : "S";
      exifData["GPS"][piexif.GPSIFD.GPSLatitude] = randomCoords();
      exifData["GPS"][piexif.GPSIFD.GPSLongitudeRef] = Math.random() > 0.5 ? "E" : "W";
      exifData["GPS"][piexif.GPSIFD.GPSLongitude] = randomCoords();

      renderForm();
      updateMapFromExif(exifData);
      jsonView.textContent = JSON.stringify(exifData, null, 2);
      showToast('üé≤ Metadata randomized');
    }

    function stripAllMetadata() {
      if (!exifData) return;
      
      exifData = {
        "0th": {},
        "Exif": {},
        "GPS": {},
        "Interop": {},
        "1st": {},
        "thumbnail": null
      };
      
      renderForm();
      updateMapFromExif(exifData);
      jsonView.textContent = JSON.stringify(exifData, null, 2);
      showToast('üóëÔ∏è All metadata stripped');
    }

    function saveImage() {
      if (!originalDataURL || !exifData) return;
      
      try {
        updateExifFromForm();
        const exifStr = piexif.dump(exifData);
        const newDataURL = piexif.insert(exifStr, originalDataURL);
        
        const link = document.createElement('a');
        link.download = `edited_${currentFile?.name || 'image.jpg'}`;
        link.href = newDataURL;
        link.click();
        
        showToast('üíæ Image saved successfully');
      } catch (err) {
        showToast('‚ùå Error saving image: ' + err.message);
      }
    }

    function initMap() {
      if (mapInstance) return;
      
      mapInstance = L.map('map').setView([40.7128, -74.0060], 3);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(mapInstance);

      mapInstance.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        addGPSToExif(lat, lng);
      });
    }

    function updateMapFromExif(data) {
      if (!mapInstance) initMap();
      
      if (mapMarker) {
        mapInstance.removeLayer(mapMarker);
        mapMarker = null;
      }

      if (!data.GPS || Object.keys(data.GPS).length === 0) {
        gpsStatus.textContent = "No GPS data";
        gpsStatus.style.background = "rgba(102, 126, 234, 0.2)";
        gpsStatus.style.color = "#667eea";
        document.getElementById('center-map').disabled = true;
        document.getElementById('clear-gps').disabled = true;
        return;
      }

      try {
        const lat = convertDMSToDD(
          data.GPS[piexif.GPSIFD.GPSLatitude],
          data.GPS[piexif.GPSIFD.GPSLatitudeRef]
        );
        const lng = convertDMSToDD(
          data.GPS[piexif.GPSIFD.GPSLongitude],
          data.GPS[piexif.GPSIFD.GPSLongitudeRef]
        );

        if (!isNaN(lat) && !isNaN(lng)) {
          mapMarker = L.marker([lat, lng]).addTo(mapInstance);
          mapInstance.setView([lat, lng], 13);
          
          gpsStatus.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
          gpsStatus.style.background = "rgba(74, 222, 128, 0.2)";
          gpsStatus.style.color = "#4ade80";
          document.getElementById('center-map').disabled = false;
          document.getElementById('clear-gps').disabled = false;
        }
      } catch (err) {
        gpsStatus.textContent = "Invalid GPS data";
        gpsStatus.style.background = "rgba(239, 68, 68, 0.2)";
        gpsStatus.style.color = "#ef4444";
      }
    }

    function convertDMSToDD(dms, ref) {
      if (!dms || !Array.isArray(dms) || dms.length !== 3) return NaN;
      
      const degrees = dms[0];
      const minutes = dms[1];
      const seconds = dms[2];
      
      let dd = degrees + minutes / 60 + seconds / 3600;
      
      if (ref === "S" || ref === "W") {
        dd = dd * -1;
      }
      
      return dd;
    }

    function convertDDToDMS(dd) {
      const absolute = Math.abs(dd);
      const degrees = Math.floor(absolute);
      const minutesNotTruncated = (absolute - degrees) * 60;
      const minutes = Math.floor(minutesNotTruncated);
      const seconds = (minutesNotTruncated - minutes) * 60;
      
      return [degrees, minutes, seconds];
    }

    function addGPSToExif(lat, lng) {
      if (!exifData) return;
      
      if (!exifData["GPS"]) exifData["GPS"] = {};
      
      exifData["GPS"][piexif.GPSIFD.GPSLatitudeRef] = lat >= 0 ? "N" : "S";
      exifData["GPS"][piexif.GPSIFD.GPSLatitude] = convertDDToDMS(lat);
      exifData["GPS"][piexif.GPSIFD.GPSLongitudeRef] = lng >= 0 ? "E" : "W";
      exifData["GPS"][piexif.GPSIFD.GPSLongitude] = convertDDToDMS(lng);
      
      renderForm();
      updateMapFromExif(exifData);
      jsonView.textContent = JSON.stringify(exifData, null, 2);
      showToast('üìç GPS location added');
    }

    function clearGPS() {
      if (!exifData) return;
      
      exifData["GPS"] = {};
      
      renderForm();
      updateMapFromExif(exifData);
      jsonView.textContent = JSON.stringify(exifData, null, 2);
      showToast('üóëÔ∏è GPS data removed');
    }

    function showComparison() {
      const compareContent = document.getElementById('compare-content');
      compareContent.innerHTML = `
        <div class="compare-item">
          <h4>Original Metadata</h4>
          <pre>${JSON.stringify(originalExifData, null, 2)}</pre>
        </div>
        <div class="compare-item">
          <h4>Current Metadata</h4>
          <pre>${JSON.stringify(exifData, null, 2)}</pre>
        </div>
      `;
      compareModal.classList.add('show');
    }

    async function searchLocation() {
      const query = document.getElementById('search-location').value.trim();
      if (!query) return;
      
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        if (data && data.length > 0) {
          const lat = parseFloat(data[0].lat);
          const lng = parseFloat(data[0].lon);
          
          mapInstance.setView([lat, lng], 13);
          showToast(`üìç Found: ${data[0].display_name}`);
        } else {
          showToast('‚ùå Location not found');
        }
      } catch (err) {
        showToast('‚ùå Search error: ' + err.message);
      }
    }

    function loadBatchFiles(files) {
      batchFiles = Array.from(files);
      currentBatchIndex = 0;
      
      if (batchFiles.length > 0) {
        document.getElementById('batch-controls').style.display = 'flex';
        updateBatchCounter();
        loadImage(batchFiles[currentBatchIndex]);
      }
    }

    function updateBatchCounter() {
      document.getElementById('batch-counter').textContent = `${currentBatchIndex + 1} / ${batchFiles.length}`;
    }

    function navigateBatch(direction) {
      if (batchFiles.length === 0) return;
      
      currentBatchIndex += direction;
      if (currentBatchIndex < 0) currentBatchIndex = batchFiles.length - 1;
      if (currentBatchIndex >= batchFiles.length) currentBatchIndex = 0;
      
      updateBatchCounter();
      loadImage(batchFiles[currentBatchIndex]);
    }

    function saveAllBatch() {
      showToast('üíæ Saving all images...');
      
      batchFiles.forEach((file, index) => {
        setTimeout(() => {
          const reader = new FileReader();
          reader.onload = function(e) {
            try {
              const base64 = e.target.result;
              const exif = piexif.load(base64);
              const exifStr = piexif.dump(exif);
              const newDataURL = piexif.insert(exifStr, base64);
              
              const link = document.createElement('a');
              link.download = `edited_${file.name}`;
              link.href = newDataURL;
              link.click();
            } catch (err) {
              console.error('Error saving:', file.name, err);
            }
          };
          reader.readAsDataURL(file);
        }, index * 500);
      });
    }

    // Event Listeners
    mainUpload.addEventListener('change', (e) => {
      if (e.target.files.length) loadImage(e.target.files[0]);
    });

    batchUpload.addEventListener('change', (e) => {
      if (e.target.files.length) loadBatchFiles(e.target.files);
    });

    metaUpload.addEventListener('change', (e) => {
      if (e.target.files.length) loadImage(e.target.files[0], true);
    });

    searchMeta.addEventListener('input', renderForm);

    scrambleBtn.addEventListener('click', scrambleMetadata);
    saveBtn.addEventListener('click', saveImage);
    stripAllBtn.addEventListener('click', stripAllMetadata);
    compareBtn.addEventListener('click', showComparison);

    document.getElementById('copy-json').addEventListener('click', () => {
      navigator.clipboard.writeText(JSON.stringify(exifData, null, 2));
      showToast('üìã JSON copied to clipboard');
    });

    document.getElementById('download-json').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(exifData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.download = 'metadata.json';
      link.href = url;
      link.click();
      URL.revokeObjectURL(url);
      showToast('‚¨áÔ∏è JSON downloaded');
    });

    document.getElementById('center-map').addEventListener('click', () => {
      if (mapMarker) {
        mapInstance.setView(mapMarker.getLatLng(), 13);
      }
    });

    document.getElementById('clear-gps').addEventListener('click', clearGPS);

    document.getElementById('add-gps').addEventListener('click', () => {
      showToast('üó∫Ô∏è Click on the map to add GPS location');
    });

    document.getElementById('search-location-btn').addEventListener('click', searchLocation);

    document.getElementById('search-location').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') searchLocation();
    });

    document.querySelector('.modal-close').addEventListener('click', () => {
      compareModal.classList.remove('show');
    });

    compareModal.addEventListener('click', (e) => {
      if (e.target === compareModal) {
        compareModal.classList.remove('show');
      }
    });

    document.getElementById('prev-batch').addEventListener('click', () => navigateBatch(-1));
    document.getElementById('next-batch').addEventListener('click', () => navigateBatch(1));
    document.getElementById('save-all-batch').addEventListener('click', saveAllBatch);

    // Initialize map on load
    setTimeout(initMap, 100);
  </script>
</body>
</html>