<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Photo Metadata Tool</title>
  <script src="https://cdn.jsdelivr.net/npm/piexifjs@1.0.6/piexif.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 100%);
      color: #e0e0e0;
      min-height: 100vh;
      padding-bottom: 2rem;
    }

    header {
      background: rgba(30, 30, 50, 0.9);
      backdrop-filter: blur(10px);
      padding: 1.5rem 2rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    h1 {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 1rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }

    button, .file-input-wrapper {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 0.65rem 1.25rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      position: relative;
      overflow: hidden;
    }

    button:hover:not(:disabled), .file-input-wrapper:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
    }

    button:active:not(:disabled), .file-input-wrapper:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .file-input-wrapper {
      display: inline-block;
      position: relative;
    }

    .file-input-wrapper input[type="file"] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    #scramble {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      box-shadow: 0 4px 12px rgba(245, 87, 108, 0.3);
    }

    #save {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
    }

    #strip-all {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      box-shadow: 0 4px 12px rgba(250, 112, 154, 0.3);
    }

    #copy-meta {
      background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
      box-shadow: 0 4px 12px rgba(48, 207, 208, 0.3);
    }

    #compare {
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      color: #333;
      box-shadow: 0 4px 12px rgba(168, 237, 234, 0.3);
    }

    main {
      max-width: 1800px;
      margin: 2rem auto;
      padding: 0 2rem;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }

    @media (max-width: 1200px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: rgba(30, 30, 50, 0.6);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .panel h2 {
      font-size: 1.3rem;
      margin-bottom: 1rem;
      color: #a8b2d1;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .panel h3 {
      font-size: 1.1rem;
      margin: 1.5rem 0 0.75rem;
      color: #a8b2d1;
    }

    .image-container {
      position: relative;
    }

    #preview {
      width: 100%;
      height: auto;
      max-height: 500px;
      object-fit: contain;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.3);
      display: block;
    }

    .image-info {
      margin-top: 1rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.75rem;
    }

    .info-item {
      background: rgba(0, 0, 0, 0.3);
      padding: 0.75rem;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .info-label {
      font-size: 0.75rem;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .info-value {
      font-size: 1rem;
      font-weight: 600;
      color: #a8b2d1;
      margin-top: 0.25rem;
    }

    .placeholder {
      width: 100%;
      height: 300px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      color: #666;
      font-size: 1.1rem;
      border: 2px dashed rgba(102, 126, 234, 0.3);
    }

    .placeholder-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .search-box {
      margin-bottom: 1rem;
      position: relative;
    }

    .search-box input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 2.5rem;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(0, 0, 0, 0.3);
      color: #e0e0e0;
      font-size: 0.9rem;
    }

    .search-box::before {
      content: "üîç";
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1rem;
    }

    #metadata-form {
      max-height: 450px;
      overflow-y: auto;
      padding-right: 0.5rem;
    }

    #metadata-form::-webkit-scrollbar, #json-view::-webkit-scrollbar {
      width: 8px;
    }

    #metadata-form::-webkit-scrollbar-track, #json-view::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }

    #metadata-form::-webkit-scrollbar-thumb, #json-view::-webkit-scrollbar-thumb {
      background: rgba(102, 126, 234, 0.5);
      border-radius: 4px;
    }

    #metadata-form::-webkit-scrollbar-thumb:hover, #json-view::-webkit-scrollbar-thumb:hover {
      background: rgba(102, 126, 234, 0.7);
    }

    .section-title {
      font-size: 0.9rem;
      font-weight: 700;
      color: #667eea;
      margin: 1rem 0 0.5rem;
      padding-bottom: 0.25rem;
      border-bottom: 1px solid rgba(102, 126, 234, 0.3);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section-title:first-child {
      margin-top: 0;
    }

    .section-actions {
      display: flex;
      gap: 0.5rem;
    }

    .mini-btn {
      background: rgba(102, 126, 234, 0.2);
      border: 1px solid rgba(102, 126, 234, 0.3);
      color: #667eea;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .mini-btn:hover {
      background: rgba(102, 126, 234, 0.3);
    }

    .entry {
      margin-bottom: 1rem;
      position: relative;
    }

    .entry label {
      display: block;
      font-size: 0.85rem;
      color: #a8b2d1;
      margin-bottom: 0.35rem;
      font-weight: 500;
    }

    .entry input {
      width: 100%;
      padding: 0.6rem 2.5rem 0.6rem 0.6rem;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(0, 0, 0, 0.3);
      color: #e0e0e0;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }

    .entry input:focus {
      outline: none;
      border-color: #667eea;
      background: rgba(0, 0, 0, 0.4);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .entry-actions {
      position: absolute;
      right: 0.5rem;
      top: 1.8rem;
      display: flex;
      gap: 0.25rem;
    }

    .entry-btn {
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      padding: 0.25rem;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }

    .entry-btn:hover {
      color: #667eea;
      transform: scale(1.1);
    }

    #json-view {
      background: rgba(0, 0, 0, 0.4);
      padding: 1rem;
      border-radius: 8px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      color: #a8e6cf;
      border: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
    }

    .json-actions {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .map-panel {
      grid-column: 1 / -1;
    }

    #map {
      height: 400px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .map-controls {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    .empty-state {
      text-align: center;
      padding: 2rem;
      color: #666;
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .info-badge {
      display: inline-block;
      background: rgba(102, 126, 234, 0.2);
      color: #667eea;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }

    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: rgba(30, 30, 50, 0.95);
      backdrop-filter: blur(10px);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      border: 1px solid rgba(102, 126, 234, 0.5);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      transform: translateY(150%);
      transition: transform 0.3s ease;
      z-index: 1000;
      max-width: 300px;
    }

    .toast.show {
      transform: translateY(0);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: rgba(30, 30, 50, 0.95);
      border-radius: 16px;
      padding: 2rem;
      max-width: 90%;
      max-height: 90%;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .modal-close {
      background: none;
      border: none;
      color: #999;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .compare-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }

    .compare-item h4 {
      color: #667eea;
      margin-bottom: 0.5rem;
    }

    .diff-highlight {
      background: rgba(245, 87, 108, 0.2);
      border-left: 3px solid #f5576c;
      padding-left: 0.5rem;
    }

    .tab-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .tab-btn {
      background: none;
      border: none;
      color: #888;
      padding: 0.75rem 1.25rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s ease;
      font-weight: 600;
    }

    .tab-btn:hover {
      color: #a8b2d1;
    }

    .tab-btn.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .history-item {
      background: rgba(0, 0, 0, 0.3);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .history-item:hover {
      background: rgba(0, 0, 0, 0.5);
      border-color: #667eea;
    }

    .history-time {
      font-size: 0.75rem;
      color: #888;
    }

    .batch-controls {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>üì∑ Photo Metadata Editor Pro</h1>
    <div class="toolbar">
      <div class="file-input-wrapper">
        üìÅ Load Image
        <input type="file" id="main-upload" accept="image/jpeg,image/jpg" />
      </div>
      <div class="file-input-wrapper">
        üìÇ Batch Load
        <input type="file" id="batch-upload" accept="image/jpeg,image/jpg" multiple />
      </div>
      <div class="file-input-wrapper">
        üîÑ Copy Metadata From
        <input type="file" id="meta-upload" accept="image/jpeg,image/jpg" title="Copy metadata from another photo"/>
      </div>
      <button id="strip-all" disabled>üóëÔ∏è Strip All Metadata</button>
      <button id="scramble" disabled>üé≤ Randomize</button>
      <button id="compare" disabled>‚öñÔ∏è Compare</button>
      <button id="save" disabled>üíæ Save & Download</button>
    </div>
  </header>

  <main>
    <section class="panel image-panel">
      <h2>üñºÔ∏è Image Preview</h2>
      <div id="preview-container">
        <div class="placeholder">
          <div class="placeholder-icon">üì∏</div>
          <p>Drop an image or click "Load Image" to get started</p>
        </div>
      </div>
      <div class="image-info" id="image-info" style="display: none;">
        <div class="info-item">
          <div class="info-label">Dimensions</div>
          <div class="info-value" id="dimensions">-</div>
        </div>
        <div class="info-item">
          <div class="info-label">File Size</div>
          <div class="info-value" id="filesize">-</div>
        </div>
        <div class="info-item">
          <div class="info-label">Format</div>
          <div class="info-value" id="format">JPEG</div>
        </div>
        <div class="info-item">
          <div class="info-label">Camera</div>
          <div class="info-value" id="camera">-</div>
        </div>
      </div>
      <div class="batch-controls" id="batch-controls" style="display: none;">
        <button id="prev-batch">‚¨ÖÔ∏è Previous</button>
        <span id="batch-counter" style="color: #a8b2d1; padding: 0.65rem 1.25rem;">1 / 1</span>
        <button id="next-batch">‚û°Ô∏è Next</button>
        <button id="save-all-batch">üíæ Save All</button>
      </div>
    </section>
    
    <section class="panel metadata-panel">
      <div class="tab-buttons">
        <button class="tab-btn active" data-tab="editor">‚úèÔ∏è Editor</button>
        <button class="tab-btn" data-tab="json">üìÑ JSON</button>
        <button class="tab-btn" data-tab="history">üïí History</button>
      </div>

      <div id="editor-tab">
        <div class="search-box">
          <input type="text" id="search-meta" placeholder="Search metadata fields..." />
        </div>
        <div id="metadata-form">
          <div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <p>No metadata loaded yet</p>
          </div>
        </div>
      </div>

      <div id="json-tab" style="display: none;">
        <div class="json-actions">
          <button class="mini-btn" id="copy-json">üìã Copy</button>
          <button class="mini-btn" id="download-json">‚¨áÔ∏è Download</button>
          <button class="mini-btn" id="import-json">üì§ Import</button>
        </div>
        <pre id="json-view">{}</pre>
      </div>

      <div id="history-tab" style="display: none;">
        <div id="history-list">
          <div class="empty-state">
            <div class="empty-state-icon">üïí</div>
            <p>No history yet</p>
          </div>
        </div>
        <button class="mini-btn" id="clear-history" style="margin-top: 1rem; width: 100%;">Clear History</button>
      </div>
    </section>

    <section class="panel map-panel">
      <h2>üó∫Ô∏è GPS Location <span class="info-badge" id="gps-status">No GPS data</span></h2>
      <div id="map"></div>
      <div class="map-controls">
        <button class="mini-btn" id="center-map" disabled>üéØ Center on Marker</button>
        <button class="mini-btn" id="clear-gps" disabled>üóëÔ∏è Remove GPS</button>
        <button class="mini-btn" id="add-gps" disabled>‚ûï Add GPS Here</button>
        <input type="text" id="search-location" placeholder="Search location..." style="flex: 1; min-width: 200px; padding: 0.5rem; border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.1); background: rgba(0, 0, 0, 0.3); color: #e0e0e0;" />
        <button class="mini-btn" id="search-location-btn">üîç Search</button>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <div id="compare-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚öñÔ∏è Metadata Comparison</h2>
        <button class="modal-close">√ó</button>
      </div>
      <div class="compare-grid" id="compare-content"></div>
    </div>
  </div>

  <script>
    const previewContainer = document.getElementById("preview-container");
    const mainUpload = document.getElementById("main-upload");
    const batchUpload = document.getElementById("batch-upload");
    const metaUpload = document.getElementById("meta-upload");
    const form = document.getElementById("metadata-form");
    const jsonView = document.getElementById("json-view");
    const scrambleBtn = document.getElementById("scramble");
    const saveBtn = document.getElementById("save");
    const stripAllBtn = document.getElementById("strip-all");
    const compareBtn = document.getElementById("compare");
    const gpsStatus = document.getElementById("gps-status");
    const searchMeta = document.getElementById("search-meta");
    const toast = document.getElementById("toast");

    let originalDataURL = null;
    let originalExifData = null;
    let exifData = null;
    let currentFile = null;
    let mapInitialized = false;
    let mapInstance = null;
    let mapMarker = null;
    let editHistory = [];
    let batchFiles = [];
    let currentBatchIndex = 0;

    // Drag and drop
    previewContainer.addEventListener('dragover', (e) => {
      e.preventDefault();
      previewContainer.style.borderColor = '#667eea';
    });

    previewContainer.addEventListener('dragleave', () => {
      previewContainer.style.borderColor = '';
    });

    previewContainer.addEventListener('drop', (e) => {
      e.preventDefault();
      previewContainer.style.borderColor = '';
      if (e.dataTransfer.files.length) {
        loadImage(e.dataTransfer.files[0]);
      }
    });

    function showToast(message, duration = 3000) {
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), duration);
    }

    function saveToHistory(action) {
      editHistory.unshift({
        action,
        timestamp: new Date().toISOString(),
        exifData: JSON.parse(JSON.stringify(exifData))
      });
      if (editHistory.length > 20) editHistory.pop();
      updateHistoryUI();
    }

    function updateHistoryUI() {
      const historyList = document.getElementById("history-list");
      if (editHistory.length === 0) {
        historyList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üïí</div><p>No history yet</p></div>';
        return;
      }
      
      historyList.innerHTML = editHistory.map((item, index) => `
        <div class="history-item" data-index="${index}">
          <strong>${item.action}</strong>
          <div class="history-time">${new Date(item.timestamp).toLocaleString()}</div>
        </div>
      `).join('');

      historyList.querySelectorAll('.history-item').forEach(item => {
        item.addEventListener('click', () => {
          const index = parseInt(item.dataset.index);
          exifData = JSON.parse(JSON.stringify(editHistory[index].exifData));
          renderForm();
          updateMapFromExif(exifData);
          jsonView.textContent = JSON.stringify(exifData, null, 2);
          showToast('‚úÖ Restored from history');
        });
      });
    }

    function loadImage(file, replaceMetaOnly = false) {
      currentFile = file;
      const reader = new FileReader();
      reader.onload = function (e) {
        const base64 = e.target.result;

        if (!replaceMetaOnly) {
          originalDataURL = base64;
          const img = new Image();
          img.onload = function() {
            document.getElementById('dimensions').textContent = `${img.width} √ó ${img.height}`;
          };
          img.id = 'preview';
          img.src = base64;
          previewContainer.innerHTML = '';
          previewContainer.appendChild(img);
          
          document.getElementById('filesize').textContent = formatBytes(file.size);
          document.getElementById('image-info').style.display = 'grid';
        }

        try {
          const exif = piexif.load(base64);
          exifData = exif;
          originalExifData = JSON.parse(JSON.stringify(exif));
          
          if (!exifData["GPS"]) {
            exifData["GPS"] = {};
          }

          // Update camera info
          const make = exifData["0th"]?.[piexif.ImageIFD.Make] || '';
          const model = exifData["0th"]?.[piexif.ImageIFD.Model] || '';
          document.getElementById('camera').textContent = make && model ? `${make} ${model}` : 'Unknown';
          
          scrambleBtn.disabled = false;
          saveBtn.disabled = false;
          stripAllBtn.disabled = false;
          compareBtn.disabled = false;
          document.getElementById('add-gps').disabled = false;

          if (!replaceMetaOnly) {
            saveToHistory('Image Loaded');
          } else {
            saveToHistory('Metadata Replaced');
          }
        } catch (err) {
          console.error("Error loading EXIF:", err);
          exifData = {
            "0th": {},
            "Exif": {},
            "GPS": {},
            "Interop": {},
            "1st": {},
            "thumbnail": null
          };
          originalExifData = JSON.parse(JSON.stringify(exifData));
          document.getElementById('camera').textContent = 'None';
          scrambleBtn.disabled = false;
          saveBtn.disabled = false;
          stripAllBtn.disabled = false;
          compareBtn.disabled = false;
          document.getElementById('add-gps').disabled = false;
        }

        renderForm();
        updateMapFromExif(exifData);
        jsonView.textContent = JSON.stringify(exifData, null, 2);
      };
      reader.readAsDataURL(file);
    }